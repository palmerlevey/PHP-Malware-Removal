<?php
/***
*       
*   This is a PHP Malware Removal Project || Work In Progress
*   
* 
***/

// By default all reported malware is disabled by renaming to $FILENAME.OFF, so this renames to original file name.
function enableMalware()
{
    $directory_iterator = new RecursiveIteratorIterator(new RecursiveDirectoryIterator('./', RecursiveDirectoryIterator::SKIP_DOTS));
    foreach($directory_iterator as $filename => $file)
    {
        if($file->getExtension()!='OFF'){
                continue;
            }
        $enabledname = str_replace(".OFF","",$filename);
            rename($filename,$enabledname);
            echo "Re-enabled ".$enabledname.PHP_EOL;
    }
}
// Strips string content (malicious) from the files.
function deleteMalware()
{
    $directory_iterator = new RecursiveIteratorIterator(new RecursiveDirectoryIterator('./', RecursiveDirectoryIterator::SKIP_DOTS));
		$total = 0;
		$counter = 0;
    foreach($directory_iterator as $filename => $file)
    {
		$total +=1;
        $content = file_get_contents($filename);
        $reg = '/<\?\s*php\s*if\(!isset\(\$GLOBALS\[\"\\\\x61(.*?)-1;\s*\?>/s';
        $count = 0;

        $newContent = preg_replace ($reg, '', $content, -1, $count);

        if($count === 1) {
            file_put_contents ($filename, $newContent);
			echo $filename . "<html> <br /> </html>";
			$counter +=1;
        }
    }
	echo "".PHP_EOL;
	echo "Total Files: " .$total.PHP_EOL;
	echo "Total Files Fixed: " .$counter.PHP_EOL;
	echo "".PHP_EOL;
};

echo "Process Started.".PHP_EOL;
enableMalware();
deleteMalware();
echo "Process Completed.".PHP_EOL;
?>